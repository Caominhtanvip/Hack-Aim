--// ESP Box and Healthbar

local ESPFolder = Instance.new("Folder", game.CoreGui)
ESPFolder.Name = "ESP_Boxes"

local function CreateESP(Player)
    if Player == LocalPlayer then return end
    local Character = Player.Character
    if not Character then return end
    local Humanoid = Character:FindFirstChildOfClass("Humanoid")
    if not Humanoid then return end
    local HRP = Character:FindFirstChild("HumanoidRootPart")
    if not HRP then return end

    local Box = Drawing.new("Square")
    Box.Thickness = 1
    Box.Color = Color3.fromRGB(255, 255, 255)
    Box.Transparency = 1
    Box.Visible = false

    local HealthBar = Drawing.new("Line")
    HealthBar.Thickness = 2
    HealthBar.Color = Color3.fromRGB(0, 255, 0)
    HealthBar.Transparency = 1
    HealthBar.Visible = false

    RunService.RenderStepped:Connect(function()
        if not Character or not HRP or not Humanoid or Humanoid.Health <= 0 then
            Box.Visible = false
            HealthBar.Visible = false
            return
        end

        local Vector, OnScreen = Camera:WorldToViewportPoint(HRP.Position)
        if OnScreen then
            local sizeY = 3 -- chiều cao box
            local sizeX = sizeY * 0.6 -- chiều ngang box

            local top = Camera:WorldToViewportPoint(HRP.Position + Vector3.new(0, sizeY, 0))
            local bottom = Camera:WorldToViewportPoint(HRP.Position - Vector3.new(0, sizeY, 0))

            local boxHeight = (top.Y - bottom.Y)
            local boxWidth = boxHeight * 0.6

            Box.Size = Vector2.new(boxWidth, boxHeight)
            Box.Position = Vector2.new(Vector.X - boxWidth / 2, Vector.Y - boxHeight / 2)
            Box.Color = Player.TeamColor.Color
            Box.Visible = true

            local healthPercent = Humanoid.Health / Humanoid.MaxHealth
            HealthBar.From = Vector2.new(Box.Position.X - 5, Box.Position.Y + boxHeight)
            HealthBar.To = Vector2.new(Box.Position.X - 5, Box.Position.Y + boxHeight * (1 - healthPercent))
            HealthBar.Color = Color3.fromRGB(255 - 255 * healthPercent, 255 * healthPercent, 0)
            HealthBar.Visible = true
        else
            Box.Visible = false
            HealthBar.Visible = false
        end
    end)
end

for _, player in ipairs(Players:GetPlayers()) do
    CreateESP(player)
end

Players.PlayerAdded:Connect(function(player)
    player.CharacterAdded:Connect(function()
        wait(1)
        CreateESP(player)
    end)
end)
